name: Build and Push Docker Image with Semantic Tags

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Extract SemVer
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "MINOR=${VERSION%.*}" >> $GITHUB_ENV
          echo "MAJOR=${VERSION%%.*}" >> $GITHUB_ENV

      - name: Docker Login
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and Push
        run: |
          IMAGE=yourdockerhubuser/sample-app
          docker build -t $IMAGE:$VERSION .
          docker tag $IMAGE:$VERSION $IMAGE:${MINOR}
          docker tag $IMAGE:$VERSION $IMAGE:${MAJOR}
          docker tag $IMAGE:$VERSION $IMAGE:latest

          docker push $IMAGE:$VERSION
          docker push $IMAGE:${MINOR}
          docker push $IMAGE:${MAJOR}
          docker push $IMAGE:latest